generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  farcasterFid      Int           @unique
  username          String
  displayName       String?
  avatar            String?
  walletAddress     String?
  totalGamesPlayed  Int           @default(0)
  totalWagered      Decimal       @default(0) @db.Decimal(78, 0)
  totalWon          Decimal       @default(0) @db.Decimal(78, 0)
  totalLost         Decimal       @default(0) @db.Decimal(78, 0)
  biggestWin        Decimal       @default(0) @db.Decimal(78, 0)
  biggestMultiplier Decimal       @default(0) @db.Decimal(10, 4)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  games             Game[]
  gameSessions      GameSession[]
  transactions      Transaction[]

  @@index([farcasterFid])
  @@index([walletAddress])
}

model GameSession {
  id                String            @id @default(cuid())
  userId            String
  preliminaryGameId String            @unique
  onChainGameId     BigInt?           @unique
  betAmount         Decimal           @db.Decimal(78, 0)
  seed              String
  commitmentHash    String
  gameConfig        Json
  gameMode          String            @default("MEDIUM")
  currentRow        Int               @default(0)
  currentMultiplier Decimal           @default(1) @db.Decimal(10, 4)
  potentialPayout   Decimal           @default(0) @db.Decimal(78, 0)
  status            GameSessionStatus @default(PENDING_CHAIN)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  chainConfirmedAt  DateTime?
  completedAt       DateTime?
  createTxHash      String?
  finalizeTxHash    String?
  finalGameId       String?           @unique
  finalGame         Game?             @relation(fields: [finalGameId], references: [id])
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([onChainGameId])
}

model Game {
  id                String        @id @default(cuid())
  userId            String
  onChainGameId     BigInt?       @unique
  preliminaryGameId String?       @unique
  betAmount         Decimal       @db.Decimal(78, 0)
  payoutAmount      Decimal       @default(0) @db.Decimal(78, 0)
  profitLoss        Decimal       @db.Decimal(78, 0)
  result            GameResult
  finalMultiplier   Decimal       @default(1) @db.Decimal(10, 4)
  rowsCompleted     Int           @default(0)
  totalRows         Int           @default(0)
  seed              String?
  gameConfig        Json?
  gameMode          String        @default("MEDIUM")
  gameType          String        @default("multiplier")
  createTxHash      String?
  finalizeTxHash    String?
  playedAt          DateTime      @default(now())
  completedAt       DateTime?
  metadata          Json?
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  session           GameSession?
  transactions      Transaction[]

  @@index([userId])
  @@index([result])
  @@index([playedAt])
  @@index([userId, playedAt])
}

model Transaction {
  id          String            @id @default(cuid())
  userId      String
  type        TransactionType
  amount      Decimal           @db.Decimal(78, 0)
  status      TransactionStatus @default(PENDING)
  txHash      String?           @unique
  blockNumber BigInt?
  gameId      String?
  createdAt   DateTime          @default(now())
  confirmedAt DateTime?
  game        Game?             @relation(fields: [gameId], references: [id])
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gameId])
  @@index([type])
  @@index([txHash])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model ContractState {
  id              String   @id @default("singleton")
  potBalance      Decimal  @db.Decimal(78, 0)
  maxBet          Decimal  @db.Decimal(78, 0)
  maxPayout       Decimal  @db.Decimal(78, 0)
  isPaused        Boolean  @default(false)
  contractAddress String
  tokenAddress    String
  lastSyncedBlock BigInt
  updatedAt       DateTime @updatedAt
}

enum GameSessionStatus {
  PENDING_CHAIN
  ACTIVE
  CASHING_OUT
  MARKING_LOST
  COMPLETED
  EXPIRED
  FAILED
}

enum GameResult {
  WIN
  LOSS
  DRAW
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  GAME_ENTRY
  GAME_PAYOUT
  GAME_BET
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

// ============================================
// WAITLIST MODEL (Pre-launch signups)
// ============================================
model Waitlist {
  id String @id @default(cuid())

  // User info
  farcasterFid  Int     @unique
  username      String
  displayName   String?
  avatar        String?
  walletAddress String?

  // Referral tracking
  referredBy String? // FID of referrer

  // Timestamps
  createdAt DateTime @default(now())

  @@index([farcasterFid])
  @@index([createdAt])
}
