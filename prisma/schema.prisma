// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL (Enhanced with gaming stats)
// ============================================
model User {
  id            String   @id @default(cuid())
  farcasterFid  Int      @unique
  username      String
  displayName   String?
  avatar        String?
  walletAddress String?

  // Stats (denormalized for performance)
  totalGamesPlayed  Int      @default(0)
  totalWagered      Decimal  @default(0) @db.Decimal(78, 0)
  totalWon          Decimal  @default(0) @db.Decimal(78, 0)
  totalLost         Decimal  @default(0) @db.Decimal(78, 0)
  biggestWin        Decimal  @default(0) @db.Decimal(78, 0)
  biggestMultiplier Decimal  @default(0) @db.Decimal(10, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  games        Game[]
  transactions Transaction[]
  gameSessions GameSession[]

  @@index([farcasterFid])
  @@index([walletAddress])
}

// ============================================
// GAME SESSION STATUS
// ============================================
enum GameSessionStatus {
  PENDING_CHAIN   // Waiting for createGame tx confirmation
  ACTIVE          // On-chain confirmed, player is playing
  CASHING_OUT     // Player requested cash out, tx pending
  MARKING_LOST    // Player lost, marking tx pending
  COMPLETED       // Game finished (won or lost)
  EXPIRED         // Game timed out
  FAILED          // Transaction failed
}

// ============================================
// GAME SESSION MODEL (Off-chain game state)
// ============================================
model GameSession {
  id String @id @default(cuid())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Game identifiers
  preliminaryGameId String  @unique // UUID generated by backend (bytes32 hex)
  onChainGameId     BigInt? @unique // Assigned by contract

  // Bet info
  betAmount Decimal @db.Decimal(78, 0) // In token wei

  // Commitment data (secret until reveal)
  seed           String // 32-byte hex string
  commitmentHash String // keccak256 hash

  // Game configuration (stored as JSON)
  gameConfig Json // { version, rows, deathCupPositions, multipliers }
  gameMode   String @default("MEDIUM") // EASY, MEDIUM, HARD, EXTREME

  // Current state
  currentRow        Int     @default(0) // 0 = not started, 1+ = row number
  currentMultiplier Decimal @default(1) @db.Decimal(10, 4)
  potentialPayout   Decimal @default(0) @db.Decimal(78, 0)

  // Status
  status GameSessionStatus @default(PENDING_CHAIN)

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  chainConfirmedAt DateTime? // When createGame tx confirmed
  completedAt      DateTime?

  // Transaction hashes
  createTxHash   String?
  finalizeTxHash String?

  // Final result (set on completion)
  finalGame   Game?   @relation(fields: [finalGameId], references: [id])
  finalGameId String? @unique

  @@index([userId])
  @@index([status])
  @@index([onChainGameId])
}

// ============================================
// GAME RESULT ENUM
// ============================================
enum GameResult {
  WIN
  LOSS
  DRAW // Keep for backward compatibility
}

// ============================================
// GAME MODEL (Final game results)
// ============================================
model Game {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Chain references
  onChainGameId     BigInt? @unique
  preliminaryGameId String? @unique

  // Bet & Payout
  betAmount   Decimal @db.Decimal(78, 0)
  payoutAmount Decimal @default(0) @db.Decimal(78, 0)
  profitLoss  Decimal @db.Decimal(78, 0) // Can be negative

  // Game outcome
  result          GameResult
  finalMultiplier Decimal    @default(1) @db.Decimal(10, 4)
  rowsCompleted   Int        @default(0)
  totalRows       Int        @default(0)

  // Revealed data (for verification)
  seed       String?
  gameConfig Json? // Death cup positions, multipliers
  gameMode   String @default("MEDIUM")
  gameType   String @default("multiplier") // For backward compatibility

  // Transaction hashes
  createTxHash   String?
  finalizeTxHash String?

  // Timestamps
  playedAt    DateTime  @default(now())
  completedAt DateTime?

  // Legacy field for backward compatibility
  metadata Json?

  // Relations
  transactions Transaction[]
  session      GameSession?

  @@index([userId])
  @@index([result])
  @@index([playedAt])
  @@index([userId, playedAt])
}

// ============================================
// TRANSACTION TYPE
// ============================================
enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  GAME_ENTRY
  GAME_PAYOUT
  GAME_BET // Alias for GAME_ENTRY
}

// ============================================
// TRANSACTION STATUS
// ============================================
enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

// ============================================
// TRANSACTION MODEL
// ============================================
model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transaction details
  type   TransactionType
  amount Decimal         @db.Decimal(78, 0)
  status TransactionStatus @default(PENDING)

  // Blockchain data
  txHash      String?  @unique
  blockNumber BigInt?

  // Related game
  gameId String?
  game   Game?   @relation(fields: [gameId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime  @default(now())
  confirmedAt DateTime?

  @@index([userId])
  @@index([gameId])
  @@index([type])
  @@index([txHash])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// ============================================
// CONTRACT STATE (Cached contract state)
// ============================================
model ContractState {
  id String @id @default("singleton")

  potBalance Decimal @db.Decimal(78, 0)
  maxBet     Decimal @db.Decimal(78, 0)
  maxPayout  Decimal @db.Decimal(78, 0)
  isPaused   Boolean @default(false)

  contractAddress String
  tokenAddress    String

  lastSyncedBlock BigInt
  updatedAt       DateTime @updatedAt
}

// ============================================
// WAITLIST MODEL (Pre-launch signups)
// ============================================
model Waitlist {
  id String @id @default(cuid())

  // User info
  farcasterFid  Int     @unique
  username      String
  displayName   String?
  avatar        String?
  walletAddress String?

  // Referral tracking
  referredBy String? // FID of referrer

  // Timestamps
  createdAt DateTime @default(now())

  @@index([farcasterFid])
  @@index([createdAt])
}
